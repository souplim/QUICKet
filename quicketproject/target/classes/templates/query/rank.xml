<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.common.task.RankDao">
	<select id="getRankTicket" parameterType="rankVO" resultType="rankVO">
		<![CDATA[
		select 
		s.s_num s_num, 
		nvl((ticketed.seat/total.seat*100),0) rank_ticket,
		dense_rank() over (order by nvl((ticketed.seat/total.seat*100),0) desc) rank_rank from 
		(select t.th_num, sum(nvl(h.hall_seatnum,0)) seat from theater t left join hall h on t.th_num = h.th_num
		group by t.th_num) total
		left join 
		(select h.th_num, sum(ticketed) seat from hall h left join
		(select ts.hall_id hall_id, count(ts.ti_num) ticketed from ticket_seat ts left join (select * from ticket where ti_status=1 
		and ti_date between
		to_date(#{rank_start},'yyyy-MM-dd') and to_date(#{rank_end},'yyyy-MM-dd')
		) t on ts.ti_num = t.ti_num
		group by ts.hall_id) td on h.hall_id = td.hall_id group by h.th_num) ticketed
		on total.th_num = ticketed.th_num
		left join show s
		on total.th_num = s.th_num
		]]>
	</select>
	
	<insert id="rankInsert" parameterType="rankVO">
		insert into rank(rank_id, rank_start, rank_ticket, rank_end, rank_rank, s_num) 		
		values(rank_seq.nextval, #{rank_start}, #{rank_ticket}, #{rank_end}, #{rank_rank}, #{s_num})
	</insert>

</mapper>