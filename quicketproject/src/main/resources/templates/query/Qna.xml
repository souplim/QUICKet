<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.client.qna.dao.QnaDao">

	<!-- 관리자 페이지 검색 기능 -->
	<sql id="qnaSearch">
		<if test="search=='q_title'">
			<![CDATA[ q_title LIKE '%' || #{keyword} || '%' ]]>
		</if>
		<if test="search=='q_content'">
			<![CDATA[ q_content LIKE '%' || #{keyword} || '%' ]]>
		</if>
		<if test="search=='u_id'">
			<![CDATA[ u_id LIKE '%' || #{keyword} || '%' ]]>
		</if>
		<if test="search=='q_regdate'">
			<![CDATA[ to_char(q_regdate, 'YYYY-MM-DD HH24:MI') between #{start_date} and #{end_date} ]]>
		</if>
	</sql>


	<!-- 게시판 리스트 조회 -->
	<select id="qnaList" parameterType="qna" resultType="qna">
	<![CDATA[
	SELECT
		q_no, q_title, q_content, u_id, to_char(q_regdate, 'YYYY-MM-DD HH24:MI') as q_regdate, s_num
	FROM (
		SELECT /*+ INDEX_DESC(qna pk_qna) */ 
			rownum as rnum, q_no, q_title, q_content, u_id, q_regdate, s_num
		FROM qna 
		WHERE ]]>
		<trim prefix="(" suffix=") AND " prefixOverrides ="AND">
			<include refid="qnaSearch"></include>
		</trim>
	<![CDATA[ rownum <= #{pageNum} * #{amount}
		) qnalist 
		WHERE rnum > (#{pageNum} - 1) * #{amount} and s_num = #{s_num}
	 ]]> 
	</select>  
	
	<!-- 사용자  
	<select id="qnaList" parameterType="qna" resultType="qna">
	SELECT
		q_no, q_title, q_content, u_id, to_char(q_regdate, 'YYYY-MM-DD') as q_regdate, s_num
	FROM qna
	</select>  -->
	
	
	<!-- 게시물 등록 -->
	<insert id="qnaInsert" parameterType="qna">
		INSERT INTO qna(q_no, q_title, u_id, q_content, s_num)
		VALUES(qna_seq.nextval, #{q_title}, #{u_id}, #{q_content}, #{s_num})
	</insert>
	
	<!-- 상세페이지 조회 -->
	<select id="qnaDetail" parameterType="qna" resultType="qna">
		/* Qna - qna Detail */
		SELECT
			q_no, u_id, q_title, q_content, s_num,
			TO_CHAR(q_regdate, 'YYYY-MM-DD HH24:MI') AS q_regdate
		FROM qna
		WHERE q_no = #{q_no}
	</select>
	
	<!-- 전체 레코드수 조회 -->
	<select id="qnaListCnt" parameterType="qna" resultType="int">
		SELECT count(*) FROM qna
		where s_num = #{s_num}
		<trim prefix="AND ">
			<include refid="qnaSearch"></include>
		</trim> 
	</select>
	
	<!-- 게시글 수정 -->
	<update id="qnaUpdate" parameterType="qna">
		/* Qna - qnaUpdate */
		UPDATE qna
		SET q_content = #{q_content},
			q_title = #{q_title},
        	q_update = SYSDATE
		WHERE q_no = #{q_no}
	</update>
	
	<!-- 게시글 삭제  -->
	<delete id="qnaDelete" parameterType="qna">
		/* Qna - qnaDelete */
		DELETE FROM qna WHERE q_no = #{q_no}
	</delete>
	
	
	
</mapper>